<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Paginatto ‚Äî √Årea de Membros</title>

  <!-- =========================================================
       ESTILO BASE (mantido + novas se√ß√µes de categorias)
  ========================================================== -->
  <style>
    :root{
      --bg: #0d5f70;
      --bg-soft: #0e6f83;
      --page: #f6fbfc;
      --card: #ffffff;
      --ink: #0f2024;
      --muted:#6a7a80;
      --brand:#12a4bd;
      --brand-2:#0db2c9;
      --gold:#c8a96a;
      --shadow: 0 8px 24px rgba(3,41,48,.10);
      --radius: 16px;
      --danger:#d12f2f;
      --ok:#137a3a;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }

    body{
      background: var(--page);
      color: var(--ink);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Inter, Arial, sans-serif;
      line-height: 1.55;
      min-height:100vh;
    }

    /* =========================================================
       TELA 1 ‚Äî LANDING
    ========================================================== */
    #landing{
      min-height: 100vh;
      position: relative;
      color:#ffffff;
      background-image: url('logo azul sem sombra.png');
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
    }
    #landing::before{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(
        180deg,
        rgba(0,0,0,0.55) 0%,
        rgba(0,0,0,0.65) 40%,
        rgba(0,0,0,0.75) 100%
      );
      z-index:0;
    }
    .landing-inner{
      position:relative;
      z-index:1;
      min-height:100vh;
      max-width:1100px;
      margin:0 auto;
      padding:20px 18px 40px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:space-between;
    }
    .landing-header{
      width:100%;
      display:flex;
      justify-content:center;
      margin-top:6px;
    }
    .landing-brand{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }
    .landing-brand-name{
      font-weight:700;
      letter-spacing:.22em;
      font-size:15px;
      text-transform:uppercase;
      opacity:.9;
    }
    .hero{
      width:100%;
      max-width:540px;
      margin:0 auto;
      text-align:center;
      display:grid;
      gap:18px;
      padding-bottom:60px;
    }
    .hero h1{
      font-size: clamp(28px, 5vw, 40px);
      line-height:1.15;
      font-weight:800;
      text-shadow:0 10px 30px rgba(0,0,0,.7);
    }
    .hero p{
      opacity:.95;
      max-width:420px;
      margin:0 auto;
      font-size:14px;
    }
    .btn-primary{
      appearance:none;
      border:0;
      border-radius: 999px;
      padding: 14px 22px;
      background: linear-gradient(90deg, #18b0c8 0%, #22d1e2 100%);
      color:#00333d;
      font-weight: 800;
      letter-spacing:.12em;
      text-transform:uppercase;
      box-shadow: 0 14px 34px rgba(0,0,0,.55);
      cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 18px 40px rgba(0,0,0,.65);
      filter:brightness(1.02);
    }
    .btn-primary:active{
      transform:translateY(1px);
      box-shadow:0 10px 22px rgba(0,0,0,.55);
      filter:brightness(.98);
    }

    /* =========================================================
       HEADER / NAV APP
    ========================================================== */
    #appHeader{
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(180deg, rgb(215, 217, 218) 0%, rgba(13,95,112,.92) 50%);
      color:#141313;
      box-shadow: var(--shadow);
      display:none;
    }
    .nav-wrap{
      max-width: 980px; margin: 0 auto;
      padding: 10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      position: relative;
    }
    .brand-mini{ display:flex; align-items:center; gap:10px; cursor:pointer }
    .brand-mini img{ width:30px; height:30px; object-fit:contain }
    .brand-mini span{ font-weight:800; letter-spacing:.4px }

    .menu{
      display:flex; align-items:center; gap:14px;
      overflow-x:auto; scrollbar-width:none;
    }
    .menu a, .menu button{
      color:#e8fdff; text-decoration:none; white-space:nowrap;
      font-size:14px; font-weight:700; letter-spacing:.2px;
      background:transparent; border:0; cursor:pointer; padding:8px 10px;
      border-radius: 10px;
    }
    .menu a:hover, .menu button:hover{ background: rgba(255,255,255,.08) }

    .menu-toggle{
      display:none;
      align-items:center;
      justify-content:center;
      width:32px;
      height:32px;
      border-radius:999px;
      border:0;
      background:rgba(255,255,255,0.12);
      color:#e8fdff;
      cursor:pointer;
      font-size:18px;
    }

    /* =========================================================
       BUSCA
    ========================================================== */
    .search-bar{
      max-width:980px; margin: 14px auto 0; padding: 0 14px 12px;
      display:none;
    }
    .search{
      display:flex; gap:8px; background:var(--card); border-radius:999px; padding:8px 8px 8px 14px;
      box-shadow: var(--shadow);
    }
    .search input{
      border:0; outline:0; flex:1; font-size:14px; background:transparent; color:var(--ink);
    }
    .icon-btn{
      width:38px; height:38px; border-radius:50%; border:0; cursor:pointer;
      background:linear-gradient(120deg, var(--brand) 0%, var(--brand-2) 100%);
      color:#00313a; font-weight:800;
    }

    /* =========================================================
       CONTE√öDO APP
    ========================================================== */
    #appMain{ display:none; }

    .section{
      max-width: 980px; margin: 12px auto 24px; padding: 0 14px;
    }
    .h2{
      font-size: clamp(22px, 3.8vw, 28px);
      font-weight: 900; letter-spacing:.2px;
      margin: 24px 0 8px;
    }
    .sub{ color: var(--muted); margin-bottom: 14px }

    .grid{
      display:grid; grid-template-columns: 1fr; gap:14px;
    }
    @media (min-width:540px){ .grid{ grid-template-columns: repeat(2,1fr) } }
    @media (min-width:920px){ .grid{ grid-template-columns: repeat(3,1fr) } }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      display:flex; flex-direction:column;
    }
    .thumb{ aspect-ratio: 16/9; width:100%; object-fit:cover; background:#eaf1f3 }
    .card-body{ padding:12px }
    .card h3{ font-size:16px; font-weight:800; margin: 0 0 6px }
    .card p{ color:var(--muted); font-size:13px; margin-bottom:10px }
    .row-btns{ display:flex; gap:8px; }
    .btn{
      flex:1; padding:10px 12px; border-radius:10px; border:0; cursor:pointer; font-weight:800; letter-spacing:.2px;
      background: #e9f6f8; color:#054957;
    }
    .btn:hover{ filter:brightness(.98) }
    .btn.buy{ background: linear-gradient(90deg, var(--brand) 0%, var(--brand-2) 100%); color:#002e36 }

    .msg{ color:var(--danger); font-size:14px; margin-top:6px; }

    /* =========================================================
       MODAL VIDEO / EBOOK
    ========================================================== */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.85);
      display:flex; align-items:center; justify-content:center;
      z-index:1000; padding:18px;
      animation: fade .15s ease;
    }
    .player{
      width:min(960px, 100%);
      background:#000;
      border-radius:16px;
      overflow:hidden;
      position:relative;
    }
    .player iframe{
      width:100%;
      height:min(70dvh, 520px);
      border:0;
      display:block;
      background:#000;
    }
    .close{
      position:absolute; top:10px; left:10px;
      background:rgba(0,0,0,.6); border:0; color:#fff;
      padding:8px 12px; border-radius:999px; cursor:pointer;
      z-index:2;
    }

    footer{
      text-align:center; padding:28px 12px; color:#d6f7fc; background: var(--bg);
      font-size:12px; letter-spacing:.2px;
    }

    /* =========================================================
       MOBILE NAV
    ========================================================== */
    @media (max-width: 720px){
      .nav-wrap{ justify-content:space-between; }
      .menu-toggle{ display:flex; }
      .menu{
        position:absolute;
        top:100%;
        right:14px;
        margin-top:8px;
        background:rgba(9, 113, 134, 0.98);
        border-radius:12px;
        padding:6px;
        box-shadow:var(--shadow);
        flex-direction:column;
        align-items:flex-start;
        display:none;
      }
      .menu.open{ display:flex; }
      .menu a, .menu button{
        width:100%;
        text-align:left;
        padding:8px 12px;
      }
    }

    @keyframes fade{ from{ opacity:.6 } to{ opacity:1 } }

    /* =========================================================
       √ÅREA DE COMBOS (fallback UI do m√≥dulo)
    ========================================================== */
    #comboArea{ display:none; }

    /* =========================================================
       NOVO ‚Äî CATEGORIAS (tela estilo print)
    ========================================================== */
    #cats{ display:none; }

    .cat-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width:540px){ .cat-grid{ grid-template-columns: repeat(2,1fr)} }
    @media (min-width:920px){ .cat-grid{ grid-template-columns: repeat(3,1fr)} }

    .cat-card{
      background: var(--card);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
      cursor: pointer;
      display:flex;
      flex-direction:column;
      transition: transform .12s ease, filter .12s ease;
    }
    .cat-card:hover{
      transform: translateY(-2px);
      filter: brightness(1.01);
    }
    .cat-thumb{
      aspect-ratio: 16/10;
      width:100%;
      object-fit: cover;
      background:#eaf1f3;
    }
    .cat-body{
      padding:12px 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cat-title{
      display:grid; gap:4px;
    }
    .cat-title h3{
      font-size:16px; font-weight:900; margin:0;
    }
    .cat-title p{
      font-size:12px; color:var(--muted); margin:0;
    }
    .cat-arrow{
      width:34px; height:34px;
      border-radius:999px;
      display:grid; place-items:center;
      background: #e9f6f8;
      color:#0a5664;
      font-weight:900;
      flex:0 0 auto;
    }

    /* =========================================================
       NOVO ‚Äî VIEW DA CATEGORIA (lista interna)
    ========================================================== */
    #catView{ display:none; }

    .back-row{
      display:flex; align-items:center; gap:8px; margin: 4px 0 12px;
    }
    .back-btn{
      border:0; cursor:pointer; font-weight:800;
      background:#e9f6f8; color:#054957;
      padding:8px 12px; border-radius:999px;
    }

    .recipe-list{
      display:grid;
      gap:12px;
    }

    .recipe-item{
      background: var(--card);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding:10px;
      display:grid;
      grid-template-columns: 110px 1fr;
      gap:12px;
      align-items:center;
    }
    .recipe-item img{
      width:110px; height:82px; object-fit:cover;
      border-radius:12px; background:#eaf1f3;
    }
    .recipe-info h3{
      font-size:15px; font-weight:900; margin-bottom:4px;
    }
    .recipe-info p{
      font-size:12px; color:var(--muted);
      margin-bottom:8px;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }
    .recipe-actions{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .recipe-actions .btn{
      flex: initial; min-width:140px;
    }
  </style>
</head>

<body>

  <!-- =========================================================
       TELA 1 (LANDING)
  ========================================================== -->
  <section id="landing">
    <div class="landing-inner">
      <header class="landing-header">
        <div class="landing-brand">
          <div class="landing-brand-name">PAGINATTO</div>
        </div>
      </header>

      <div class="hero">
        <h1>As melhores receitas e e-books num s√≥ lugar</h1>
        <p>Entre agora na sua √°rea de membros e acesse tudo que j√° est√° liberado para o seu e-mail.</p>
        <button class="btn-primary" id="enterBtn">Acessar</button>
      </div>
    </div>
  </section>

  <!-- =========================================================
       TELA 2 (APP)
  ========================================================== -->
  <header id="appHeader">
    <div class="nav-wrap">
      <div class="brand-mini" id="goHome">
        <img src="LOGO BRANCA COM SOMBRA.png" alt="Paginatto">
        <span>Paginatto</span>
      </div>

      <button class="menu-toggle" id="menuToggle">‚ãÆ</button>

      <nav class="menu" id="menuNav">
        <a href="#" id="menuInicio">In√≠cio</a>
        <a href="#" id="menuCats">Categorias</a>
        <a href="#" id="menuVideos">Meus V√≠deos</a>
        <a href="#" id="menuEbooks">Meus E-books</a>
        <a href="#" id="menuRecs">Recomenda√ß√µes</a>
        <button id="logoutBtn">Sair</button>
      </nav>
    </div>

    <div class="search-bar" id="searchBar">
      <div class="search">
        <input id="q" placeholder="Buscar receitas, e-books, v√≠deos‚Ä¶ (ex.: dor, bolo, airfryer)">
        <button class="icon-btn" id="btnSearch">üîé</button>
      </div>
    </div>
  </header>

  <main id="appMain">

    <!-- =========================================================
         NOVO ‚Äî SE√á√ÉO CATEGORIAS
    ========================================================== -->
    <section class="section" id="cats">
      <h2 class="h2">Categorias</h2>
      <p class="sub">Escolha uma categoria para ver as receitas liberadas.</p>
      <div id="gridCats" class="cat-grid"></div>
      <p id="msgCats" class="msg" style="display:none">Nenhuma categoria liberada para este e-mail.</p>
    </section>

    <!-- =========================================================
         NOVO ‚Äî VIEW INTERNA DA CATEGORIA
    ========================================================== -->
    <section class="section" id="catView">
      <div class="back-row">
        <button class="back-btn" id="backCats">‚Üê Voltar</button>
        <div>
          <h2 class="h2" id="catTitle" style="margin:0;">Categoria</h2>
          <p class="sub" id="catSub" style="margin:4px 0 0;">Receitas liberadas.</p>
        </div>
      </div>

      <div id="listCat" class="recipe-list"></div>
      <p id="msgCatEmpty" class="msg" style="display:none">Nenhuma receita nessa categoria ainda.</p>
    </section>

    <!-- =========================================================
         SE√á√ÉO V√çDEOS
    ========================================================== -->
    <section class="section" id="videos">
      <h2 class="h2">Suas V√≠deo Aulas</h2>
      <p class="sub">Cursos em v√≠deo liberados para o seu e-mail.</p>
      <div id="gridVideos" class="grid"></div>
      <p id="msgVideos" class="msg" style="display:none">Nenhum v√≠deo liberado para este e-mail.</p>
    </section>

    <!-- =========================================================
         SE√á√ÉO EBOOKS
    ========================================================== -->
    <section class="section" id="ebooks">
      <h2 class="h2">Seus E-books</h2>
      <p class="sub">E-books liberados para o seu e-mail.</p>
      <div id="gridEbooks" class="grid"></div>
      <p id="msgEbooks" class="msg" style="display:none">Nenhum e-book liberado para este e-mail.</p>
    </section>

    <!-- =========================================================
         SE√á√ÉO COMBO (fallback do mount)
    ========================================================== -->
    <section class="section" id="comboArea">
      <h2 class="h2">Conte√∫do do seu Combo</h2>
      <p class="sub">Aqui ficam os conte√∫dos internos do(s) combo(s).</p>
      <div id="comboMount"></div>
      <p id="msgCombo" class="msg" style="display:none">
        N√£o conseguimos listar os itens internos do combo porque o m√≥dulo n√£o exporta os dados.
      </p>
    </section>

    <!-- =========================================================
         SE√á√ÉO RECS
    ========================================================== -->
    <section class="section" id="recs">
      <h2 class="h2">Outros produtos pra voc√™</h2>
      <p class="sub">Sugest√µes do nosso cat√°logo que ainda n√£o est√£o liberadas pra voc√™.</p>
      <div id="gridRecs" class="grid"></div>
      <p id="msgRecs" class="msg" style="display:none">Nenhuma recomenda√ß√£o neste momento.</p>
    </section>

  </main>

  <footer>¬© 2025 PAGINATTO ‚Äî TODOS OS DIREITOS RESERVADOS.</footer>

  <!-- =========================================================
       SCRIPT PRINCIPAL (com categorias)
  ========================================================== -->
  <script>
  /* ============================================================
     HELPERS
  ============================================================ */
  const el = (s) => document.querySelector(s);
  const create = (tag) => document.createElement(tag);

  function safeLower(v){
    return (v || "").toString().toLowerCase();
  }

  function safeText(v){
    return (v || "").toString();
  }

  // Converte drive /view para /preview
  function toDrivePreview(url){
    if (!url) return "";
    const u = url.toString();
    if (u.includes("/preview")) return u;
    if (u.includes("/view")) return u.replace("/view", "/preview");
    return u;
  }

  /* ============================================================
     MODAL / DRIVE
  ============================================================ */
  function closeOverlay(){
    const o = el('#overlay');
    if (o) o.remove();
  }

  function openDriveModal(url, title){
    if (!url) return;
    const u = url.toString();

    if (u.includes("drive.google.com/drive/folders")){
      window.open(u, "_blank");
      return;
    }

    closeOverlay();
    const o = create('div');
    o.id = "overlay";
    o.className = "overlay";

    const p = create('div');
    p.className = "player";

    const c = create('button');
    c.className = "close";
    c.textContent = "Fechar";
    c.onclick = closeOverlay;

    const iframe = create('iframe');
    iframe.src = toDrivePreview(u);
    iframe.allowFullscreen = true;

    p.appendChild(c);
    p.appendChild(iframe);
    o.appendChild(p);
    document.body.appendChild(o);
  }

  /* ============================================================
     REGRA DE CLASSIFICA√á√ÉO
     - v√≠deo sempre ganha
  ============================================================ */
  function isCombo(item){
    const t = safeLower(item.type || item.tipo);
    return t === "combo";
  }

  function classifyItem(item){
    if (item && item.video) return "video";
    if (item && (item.ebook || item.link || item.drive_link)) return "ebook";

    const t = safeLower(item.type || item.tipo);
    if (t.includes("video")) return "video";
    return "ebook";
  }

  /* ============================================================
     CRIA√á√ÉO DE CARD (padr√£o √∫nico)
  ============================================================ */
  function createCard(item, actionText, actionFn){
    const card = create('div');
    card.className = "card";

    const img = create('img');
    img.className = "thumb";
    img.src = (
      item.thumbnail ||
      item.imagem ||
      item.capa ||
      item.cover_image_url ||
      ""
    );
    card.appendChild(img);

    const body = create('div');
    body.className = "card-body";

    const h = create('h3');
    h.textContent = item.name || item.nome || "Produto";
    body.appendChild(h);

    const p = create('p');
    p.textContent = item.descricao || item.description || "";
    body.appendChild(p);

    const row = create('div');
    row.className = "row-btns";

    const btn = create('button');
    btn.className = "btn buy";
    btn.textContent = actionText;
    btn.onclick = actionFn;

    row.appendChild(btn);
    body.appendChild(row);
    card.appendChild(body);

    return card;
  }

  /* ============================================================
     DEDUP INTELIGENTE
  ============================================================ */
  function dedupBySignature(list){
    const seen = new Set();
    const out = [];

    for (const it of list) {
      const sig = [
        it.id || "",
        it.nome || it.name || "",
        it.video || "",
        it.ebook || it.link || it.drive_link || "",
        it.__fromModule || ""
      ].join("|");

      if (seen.has(sig)) continue;
      seen.add(sig);
      out.push(it);
    }
    return out;
  }

  /* ============================================================
     IMPORTA√á√ÉO DE M√ìDULO (COMBO)
  ============================================================ */
  async function importComboModule(deliverableKey){
    const paths = [
      `/${deliverableKey}/module.js`,
      `./${deliverableKey}/module.js`,
      `modules/${deliverableKey}/module.js`,
      `./modules/${deliverableKey}/module.js`,
    ];

    let lastErr = null;

    for (const p of paths){
      try{
        const mod = await import(p);
        return mod;
      }catch(e){
        lastErr = e;
      }
    }

    console.error("N√£o achei module.js do combo:", deliverableKey, lastErr);
    return null;
  }

  async function loadModuleItems(deliverableKey){
    const mod = await importComboModule(deliverableKey);
    if (!mod) return { items: [], mod: null, categorias: [] };

    let items = [];
    let categorias = [];

    // ‚úÖ categorias exportadas?
    if (Array.isArray(mod.categorias)) categorias = mod.categorias.slice();

    // ‚úÖ padr√£o 1: export const itens = [...]
    if (Array.isArray(mod.itens)) {
      items = mod.itens.slice();
    }

    // ‚úÖ padr√£o 2: v√°rios arrays conhecidos
    if (items.length === 0){
      const candidates = [
        mod.videos,
        mod.videoAulas,
        mod.receitas,
        mod.aulas,
        mod.ebooks,
        mod.ebooksDestacados,
        mod.bonus,
        mod.items,
      ];

      candidates.forEach(arr => {
        if (Array.isArray(arr)) items.push(...arr);
      });
    }

    const normalized = items.map((it, idx) => ({
      ...it,
      __fromModule: deliverableKey,
      __order: idx
    }));

    return { items: normalized, mod, categorias };
  }

  /* ============================================================
     NAVEGA√á√ÉO
  ============================================================ */
  function showSection(id){
    const ids = ['cats','catView','videos','ebooks','comboArea','recs'];
    ids.forEach(sec => {
      const node = el('#' + sec);
      if (!node) return;
      node.style.display = (id === 'all' || sec === id) ? "block" : "none";
    });
  }

  el('#menuToggle').onclick = () => {
    el('#menuNav').classList.toggle('open');
  };

  el('#menuInicio').onclick = (ev) => { ev.preventDefault(); showSection('all'); };
  el('#menuCats').onclick   = (ev) => { ev.preventDefault(); showSection('cats'); };
  el('#menuVideos').onclick = (ev) => { ev.preventDefault(); showSection('videos'); };
  el('#menuEbooks').onclick = (ev) => { ev.preventDefault(); showSection('ebooks'); };
  el('#menuRecs').onclick   = (ev) => { ev.preventDefault(); showSection('recs'); };
  el('#goHome').onclick = () => showSection('all');

  el('#backCats').onclick = () => showSection('cats');

  /* ============================================================
     CATEGORIAS ‚Äî RENDER
  ============================================================ */
  let __catsMap = new Map();
  let __catItems = [];

  function buildCatsFromModule(moduleItems, modCats){
    // moduleItems vindos do buildComboData (tem categoria_id/nome/slug etc.)
    const map = new Map();

    // 1) se m√≥dulo exporta categorias, usa como base
    if (Array.isArray(modCats) && modCats.length){
      modCats.forEach(c => {
        const id = c.id ?? c.categoria_id ?? c.categoriaId;
        if (id == null) return;
        map.set(String(id), {
          id: String(id),
          slug: c.slug || "",
          titulo: c.titulo || c.nome || "Categoria",
          descricaoCurta: c.descricaoCurta || c.description || "",
          imagemCategoria: c.imagemCategoria || c.imagem || c.cover_image_url || "",
          items: []
        });
      });
    }

    // 2) adiciona itens agrupados
    moduleItems.forEach(it => {
      const cid = (it.categoria_id != null) ? String(it.categoria_id) : (it.categoria ? safeText(it.categoria) : "");
      if (!cid || cid === "-1") return;

      if (!map.has(cid)){
        map.set(cid, {
          id: cid,
          slug: it.categoria_slug || "",
          titulo: it.categoria || "Categoria",
          descricaoCurta: "",
          imagemCategoria: "",
          items: []
        });
      }
      map.get(cid).items.push(it);
    });

    // 3) fallback de imagem: pega thumb do primeiro item
    map.forEach(cat => {
      if (!cat.imagemCategoria){
        const first = cat.items[0];
        cat.imagemCategoria = first?.thumbnail || first?.imagem || first?.capa || first?.cover_image_url || "";
      }
    });

    return map;
  }

  function renderCats(){
    const grid = el('#gridCats');
    grid.innerHTML = "";
    const catsArr = Array.from(__catsMap.values());

    catsArr.forEach(cat => {
      const card = create('div');
      card.className = "cat-card";
      card.onclick = () => openCategory(cat.id);

      const img = create('img');
      img.className = "cat-thumb";
      img.src = cat.imagemCategoria || "";
      card.appendChild(img);

      const body = create('div');
      body.className = "cat-body";

      const left = create('div');
      left.className = "cat-title";

      const h3 = create('h3');
      h3.textContent = cat.titulo;
      const p = create('p');
      p.textContent = cat.descricaoCurta || `${cat.items.length} receitas liberadas`;

      left.appendChild(h3);
      left.appendChild(p);

      const arrow = create('div');
      arrow.className = "cat-arrow";
      arrow.textContent = "‚ûú";

      body.appendChild(left);
      body.appendChild(arrow);

      card.appendChild(body);
      grid.appendChild(card);
    });

    el('#msgCats').style.display = catsArr.length ? "none" : "block";
    el('#cats').style.display = catsArr.length ? "block" : "none";
  }

  function openCategory(catId){
    const cat = __catsMap.get(String(catId));
    if (!cat) return;

    el('#catTitle').textContent = cat.titulo;
    el('#catSub').textContent = cat.descricaoCurta || "Receitas liberadas.";

    const list = el('#listCat');
    list.innerHTML = "";

    const items = (cat.items || []).slice().sort((a,b)=> (a.ordem||a.__order||0) - (b.ordem||b.__order||0));

    items.forEach(it => {
      const row = create('div');
      row.className = "recipe-item";

      const img = create('img');
      img.src = it.thumbnail || it.imagem || it.capa || it.cover_image_url || "";
      row.appendChild(img);

      const info = create('div');
      info.className = "recipe-info";

      const h3 = create('h3');
      h3.textContent = it.nome || it.name || "Receita";

      const p = create('p');
      p.textContent = it.descricao || it.description || "";

      const actions = create('div');
      actions.className = "recipe-actions";

      if (it.video){
        const bVideo = create('button');
        bVideo.className = "btn buy";
        bVideo.textContent = "Assistir v√≠deo";
        bVideo.onclick = () => openDriveModal(it.video, it.nome || it.name);
        actions.appendChild(bVideo);
      }

      if (it.ebook || it.link || it.drive_link){
        const eb = it.ebook || it.link || it.drive_link;
        const bEbook = create('button');
        bEbook.className = "btn";
        bEbook.textContent = "Baixar e-book";
        bEbook.onclick = () => openDriveModal(eb, it.nome || it.name);
        actions.appendChild(bEbook);
      }

      info.appendChild(h3);
      info.appendChild(p);
      info.appendChild(actions);

      row.appendChild(info);
      list.appendChild(row);
    });

    el('#msgCatEmpty').style.display = items.length ? "none" : "block";
    showSection('catView');
  }

  /* ============================================================
     CARREGAR /api/my-products e explodir combos
  ============================================================ */
  async function carregarMeusProdutos(){
    const email = localStorage.getItem("chef_user_email");
    if (!email){
      alert("Fa√ßa login para acessar seus produtos.");
      return;
    }

    try {
      const r = await fetch("/api/my-products", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });

      const data = await r.json();
      if (!data.success){
        throw new Error(data.message || "Falha ao carregar produtos");
      }

      const produtosDB = Array.isArray(data.products) ? data.products : [];
      window.userEmail = email;
      window.userProducts = produtosDB;

      // 1) separa combos e n√£o-combos
      const combos = produtosDB.filter(isCombo);
      const nonCombos = produtosDB.filter(p => !isCombo(p));

      // 2) explode combos
      let moduleItems = [];
      let firstComboModule = null;
      let modCatsMerged = [];

      for (const c of combos) {
        if (!c.deliverable_key) continue;

        const { items, mod, categorias } = await loadModuleItems(c.deliverable_key);

        if (!firstComboModule && mod) firstComboModule = { mod, deliverableKey: c.deliverable_key };

        if (items.length){
          moduleItems.push(...items);
        }

        if (Array.isArray(categorias) && categorias.length){
          modCatsMerged.push(...categorias);
        }
      }

      // 2.1) salva itens combo globais
      __catItems = moduleItems.slice();

      // 2.2) monta categorias globais
      __catsMap = buildCatsFromModule(__catItems, modCatsMerged);
      renderCats();

      // 3) junta tudo (itens do m√≥dulo primeiro, depois DB)
      let allOwnedItems = [...moduleItems, ...nonCombos];

      // 4) dedup
      allOwnedItems = dedupBySignature(allOwnedItems);

      // 5) classifica por regra final
      const listaVideos = [];
      const listaEbooks = [];

      allOwnedItems.forEach(p => {
        const tipo = classifyItem(p);
        if (tipo === "video") listaVideos.push(p);
        else listaEbooks.push(p);
      });

      /* ======================
         RENDER V√çDEOS
      ====================== */
      const gridV = el("#gridVideos");
      gridV.innerHTML = "";

      listaVideos.forEach(p => {
        const link = p.video || p.drive_link || p.link || p.ebook;
        const card = createCard(
          p,
          "Assistir",
          () => openDriveModal(link, p.name || p.nome)
        );
        gridV.appendChild(card);
      });

      el("#msgVideos").style.display = gridV.children.length ? "none" : "block";

      /* ======================
         RENDER EBOOKS
      ====================== */
      const gridE = el("#gridEbooks");
      gridE.innerHTML = "";

      listaEbooks.forEach(p => {
        const link = p.ebook || p.link || p.drive_link;
        const card = createCard(
          p,
          "Abrir E-book",
          () => openDriveModal(link, p.name || p.nome)
        );
        gridE.appendChild(card);
      });

      el("#msgEbooks").style.display = gridE.children.length ? "none" : "block";

      /* ======================
         FALLBACK DO COMBO UI
      ====================== */
      const comboArea = el("#comboArea");
      const comboMount = el("#comboMount");
      const msgCombo = el("#msgCombo");

      comboMount.innerHTML = "";
      comboArea.style.display = "none";
      msgCombo.style.display = "none";

      if (combos.length && moduleItems.length === 0 && firstComboModule?.mod?.mount){
        comboArea.style.display = "block";

        try{
          const ctx = {
            email,
            products: produtosDB,
            deliverableKey: firstComboModule.deliverableKey,
            openDriveModal,
            toDrivePreview
          };

          firstComboModule.mod.mount(comboMount, ctx);
        }catch(e){
          console.error("Falha ao montar combo UI:", e);
          msgCombo.style.display = "block";
        }
      }

    } catch (err){
      console.error("Erro em carregarMeusProdutos:", err);
      alert("Erro ao carregar seus produtos.");
    }
  }

  /* ============================================================
     RECOMENDA√á√ïES
  ============================================================ */
  async function loadRecs(){
    try {
      const email = localStorage.getItem("chef_user_email");
      if (!email) return;

      const r = await fetch("/api/recommendations?email=" + encodeURIComponent(email));
      const data = await r.json();

      const lista = data.items || data.products || [];
      const grid = el("#gridRecs");
      grid.innerHTML = "";

      const listaSemCombos = lista.filter(p => !isCombo(p));

      listaSemCombos.forEach(p => {
        const card = createCard(
          p,
          "Comprar",
          () => window.open(p.checkout_link, "_blank")
        );
        grid.appendChild(card);
      });

      el("#msgRecs").style.display = grid.children.length ? "none" : "block";
    } catch(e){
      console.error("Erro em loadRecs:", e);
    }
  }

  /* ============================================================
     BUSCA LOCAL
  ============================================================ */
  function filterLocal(q){
    const term = q.toLowerCase().trim();
    if (!term){
      document.querySelectorAll(".card, .recipe-item, .cat-card").forEach(c => c.style.display="flex");
      return;
    }

    // cards normais
    const cards = document.querySelectorAll(".card");
    cards.forEach(card=>{
      const title = (card.querySelector("h3")?.textContent || "").toLowerCase();
      const desc  = (card.querySelector("p")?.textContent || "").toLowerCase();
      const show = title.includes(term) || desc.includes(term);
      card.style.display = show ? "flex" : "none";
    });

    // recipes
    const recs = document.querySelectorAll(".recipe-item");
    recs.forEach(row=>{
      const title = (row.querySelector("h3")?.textContent || "").toLowerCase();
      const desc  = (row.querySelector("p")?.textContent || "").toLowerCase();
      const show = title.includes(term) || desc.includes(term);
      row.style.display = show ? "grid" : "none";
    });

    // categorias
    const cats = document.querySelectorAll(".cat-card");
    cats.forEach(card=>{
      const title = (card.querySelector("h3")?.textContent || "").toLowerCase();
      const desc  = (card.querySelector("p")?.textContent || "").toLowerCase();
      const show = title.includes(term) || desc.includes(term);
      card.style.display = show ? "flex" : "none";
    });
  }

  el("#btnSearch").onclick = () => filterLocal(el("#q").value);
  el("#q").addEventListener("keydown", (e)=>{
    if (e.key === "Enter") filterLocal(el("#q").value);
  });

  /* ============================================================
     ABRIR √ÅREA DE MEMBROS
  ============================================================ */
  async function abrirAreaDeMembros(){
    el("#landing").style.display = "none";
    el("#appHeader").style.display = "block";
    el("#searchBar").style.display = "block";
    el("#appMain").style.display = "block";

    // come√ßa mostrando categorias se existir
    showSection("cats");

    await carregarMeusProdutos();
    await loadRecs();

    // se n√£o tiver categorias, cai pra v√≠deos
    if (!__catsMap || __catsMap.size === 0){
      showSection("videos");
    }
  }

  /* ============================================================
     BOT√ÉO ACESSAR
  ============================================================ */
  el("#enterBtn").onclick = () => {
    const email = localStorage.getItem("chef_user_email");
    if (!email){
      location.href = "login.html";
    } else {
      abrirAreaDeMembros();
    }
  };

  /* ============================================================
     LOGOUT
  ============================================================ */
  el("#logoutBtn").onclick = () => {
    localStorage.removeItem("chef_user_email");
    window.location.href = "login.html";
  };
  </script>

</body>
</html>




